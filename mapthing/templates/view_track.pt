<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" xmlns:tal="http://xml.zope.org/namespaces/tal">
<head>
    <title>View Track</title>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@js-temporal/polyfill"></script>
    <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
    <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/ui-lightness/jquery-ui.css" />
    <link rel="shortcut icon" href="${request.static_url('mapthing:static/favicon.ico')}" />
    <link rel="stylesheet" href="${request.static_url('mapthing:static/pylons.css')}" type="text/css" media="screen" charset="utf-8" />
    <link rel="stylesheet" href="${request.static_url('mapthing:static/css/jquery.ui.timerange.css')}" type="text/css" charset="utf-8" />
    <link rel="stylesheet" href="${request.static_url('mapthing:static/node_modules/bootstrap/dist/css/bootstrap.css')}"></link>
    <link rel="stylesheet" href="${request.static_url('mapthing:static/node_modules/bootstrap-daterangepicker/daterangepicker.css')}"></link>
    <link rel="stylesheet" href="${request.static_url('mapthing:static/css/view_track.css')}"></link>
    <!--[if lte IE 6]>
    <link rel="stylesheet" href="${request.static_url('mapthing:static/ie6.css')}" type="text/css" media="screen" charset="utf-8" />
    <![endif]-->
    <script src="http://openlayers.org/api/OpenLayers.js"></script>
    <!--
    <script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    -->
    <script type="text/javascript">
        var params = ${json_params};
    </script>
</head>
<body ng-controller="mapController" ng-app="mapApp">
    <div id="datepicker">
        <input type="text" date-range-picker ranged="true" ng-model="daterange"/>
    </div>
    <h1 id="full_timerange" ng-show="params.view_range">
        {{params.view_range[0]|date:'EEE MMM d, yyyy H:mm'}}
        -
        {{params.view_range[1]|date:'EEE MMM d, yyyy H:mm'}}
    </h1>
    <h2 id="sel_timerange" ng-show="params.view_range.length">{{params.view_range|humanize}}</h2>
    <div id="details">
        <div id="uni_controls">
            <label for="uni_interval">Interval</label>
            <input id="uni_interval" type="text" ng-model="uni.preinterval" value="5"/> seconds
            <label for="uni_interp">Interpolation Threshhold</label>
            <input id="uni_interp" type="text" ng-model="uni.interp" value="10"/> seconds
        </div>
        <div id="upload">
            <form action="/upload" enctype="multipart/form-data" method="POST">
                Add data: <input type="file" name="data"/>
                <input type="submit" value="Upload"/>
            </form>
        </div>
        <button id="getarea" ng-click="getInMap()">Get All in Map</button>
    </div>
    <div style="clear: both;"></div>
    <div>
        <trip-list id="trips"
            locations="data.map.locations"
            trips="data.view_points.trips"
            view-range="params.view_range"
            sel-range="params.sel_range"
            sel-loc="params.sel_loc"
            uni-params="uni"
        >
        </trip-list>
        <path-map id="map"
            data="data.map"
            sel-range="params.sel_range"
            sel-loc="params.sel_loc"
            range="params.tick_range">
        </path-map>
        <div style="clear: both;"></div>
    </div>
    <div id="timeline"></div>
    <point-sel
        start="daterange.startDate"
        end="daterange.endDate"
        bounds="params.track_bounds"
        sel-range="params.view_range"
        anim-range="params.anim_range"
        uni-params="uni"
        uni-data="data.map.spans"
        point-bounds="data.view_bounds"
        point-data="data.view_points">
    </point-sel>
    <anim-control range="params.view_range" outrange="params.anim_range"></anim-control>

    <day-view
        start="daterange.startDate"
        end="daterange.endDate"
        locations="data.map.locations"
        trips="data.view_points.trips"
        sel-loc="params.sel_loc"
        sel-range="params.sel_range"
        uni-params="uni"
        >
    </day-view>


    <script type="text/ng-template" id="anim_controls.html">
        <div class="anim_playpos"></div>
        <div class="anim_controls">
            <button ng-click="setAnim('step',-1)">&#x23EE;</button>
            <button ng-click="setAnim('rewind')">&#x23EA;</button>
            <button ng-click="setAnim('pausestop')">&#x25A0; &#x25AE; &#x25AE;</button>
            <button ng-click="setAnim('play')">&#x25B8;</button>
            <button ng-click="setAnim('step',1)">&#x23ED;</button>

            <!--
            Bigger play: &#x25B6;<br/>
            Pause: &#x25AE;&#x25AE;<br/>

            Other pauses:
            &#x2503;&#x2503;<br/>
            &#x275A;&#x275A;<br/>
            &#x2590;&#x2590;<br/>
            -->
        </div>
        <div class="anim_options">
            FPS: <input type="text" ng-model="params.fps"/>
            Speedup: <input type="text" ng-model="params.speedup"/>
            Trail length (sec): <input type="text" ng-model="params.traillen"/>
        </div>
    </script>
    <script type="text/ng-template" id="track_sel.html">
        <ul>
            <li ng-repeat="track in tracks"
                data-start="{{track.start|date:'yyyy-MM-ddTHH:mm:ss'}}"
                data-end="{{track.end|date:'yyyy-MM-ddTHH:mm:ss'}}"
                notify-last>
                <a href="#" data-trackid="{{track.id}}">
                    ({{track.id}})
                    ({{track.start|date:'yyyy/MM/dd h:mm'}} - {{track.end|date:'yyyy/MM/dd h:mm'}})
                </a>
            </li>
        </ul>
    </script>
    <script type="text/ng-template" id="trip_list.html">
        <div id="triplist">
            <div ng-repeat="trip in mergedTrips">
            <!--Trip start: {{trip.start|date:'yyyy/MM/dd HH:mm'}}-->
            <ul data-start="{{trip.start/1000}}" data-end="{{trip.end/1000}}">
            <li ng-if="trip.stops[0].range[0] !== 0" class="trip_entry">
                <a href="#" class="trip_segment">
                    {{(trip.stops[0].start - trip.start)/1000/60|number:0}} min
                </a>
            </li>
            <li ng-repeat="stop in trip.stops" class="trip_entry">
                <span class="stop_time">{{stop.start|date:'yyyy/MM/dd HH:mm'}}</span>
                <div class="stop_container">
                    <a href="#" class="trip_stop">
                        {{locations[stop.loc].name|orthis:'Location ' + stop.loc}}
                    </a>
                    <span class="stop_latlon">{{locations[stop.loc].lat|number:3}}, {{locations[stop.loc].lon|number:3}}</span>
                </div>
                <span class="stop_time">{{stop.end|date:'yyyy/MM/dd HH:mm'}}</span>
                <a ng-if="!$last" href="#" class="trip_segment">
                    {{(trip.stops[$index+1].start - stop.end)/1000/60|number:0}} min
                </a>
                <a ng-if="$last && stop.end !== trip.end" href="#" class="trip_segment">
                    {{(trip.end - stop.end)/1000/60|number:0}} min
                </a>
                <!--
                <a href="#" 
                    title="{{trip.start|date:'yyyy/MM/dd h:mm'}} - {{trip.end|date:'yyyy/MM/dd h:mm'}}">
                    Trip {{$index}} ({{(trip.end-trip.start)/1000/60|number:1}} min)
                </a>
                -->
            </ul>
            <!--Trip end: {{trip.start|date:'yyyy/MM/dd HH:mm'}}-->
            </div>
        </div>
    </script>
    <script type="text/ng-template" id="day_view.html">
        <table>
        <tr ng-repeat="day in days">
            <th>{{day}}</th>
            <td>
                <div ng-if="stop.before" ng-repeat-start="stop in dayStops[day]" style="{{stop.before|dayStyle}}">
                    <div class="line" data-range="{{stop.before}}"></div>
                </div>
                <div  style="{{stop|dayStyle}}">
                    <div class="bar" title="{{locations[stop.loc].name|orthis:'Location ' + stop.loc}} ({{stop.start|date:'HH:mm'}}-{{stop.end|date:'HH:mm'}}, {{(stop.end-stop.start)|date:'HH:mm'}})">
                    {{locations[stop.loc].name|orthis:'Location ' + stop.loc}}
                    </div>
                    <div class="bar-footer">
                        <span class="time from">{{stop.start|date:'HH:mm'}}</span>
                        <span class="time to">{{stop.end|date:'HH:mm'}}</span>
                    </div>
                </div>
                <div ng-if="stop.after" ng-repeat-end style="{{stop.after|dayStyle}}">
                    <div class="line" data-range="{{stop.after}}"></div>
                </div>
            </td>
        </tr>
        </table>
    </script>
    <script src="${request.static_url('mapthing:static/node_modules/angular/angular.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/node_modules/angular-resource/angular-resource.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/node_modules/angular-bindonce/bindonce.min.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/node_modules/moment/min/moment.min.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/node_modules/moment-range/dist/moment-range.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/node_modules/bootstrap-daterangepicker/daterangepicker.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/node_modules/angular-daterangepicker/js/angular-daterangepicker.min.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/js/app/app.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/js/app/controllers.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/js/app/directives.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/js/app/services.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/js/app/filters.js')}" type="text/javascript"></script>
    <!--<script src="${request.static_url('mapthing:static/js/mapsloader.js')}" type="text/javascript"></script>-->

    <script src="${request.static_url('mapthing:static/mapstraction/source/mxn.js')}?(openlayers)" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/js/jquery.ui.timerange.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/js/mapthing.js')}" type="text/javascript"></script>
</body>
</html>
