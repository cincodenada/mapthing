<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" xmlns:tal="http://xml.zope.org/namespaces/tal">
<head>
    <title>View Track</title>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.2/jquery-ui.min.js"></script>
    <link rel="shortcut icon" href="${request.static_url('mapthing:static/favicon.ico')}" />
    <link rel="stylesheet" href="${request.static_url('mapthing:static/pylons.css')}" type="text/css" media="screen" charset="utf-8" />
    <!--[if lte IE 6]>
    <link rel="stylesheet" href="${request.static_url('mapthing:static/ie6.css')}" type="text/css" media="screen" charset="utf-8" />
    <![endif]-->
    <script src="http://openlayers.org/api/OpenLayers.js"></script>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script src="${request.static_url('mapthing:static/mapstraction/source/mxn.js')}?(googlev3)" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/timemap/lib/timeline-1.2.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/timemap/src/timemap.js')}" type="text/javascript"></script>
    <script src="${request.static_url('mapthing:static/js/jquery.ui.timerange.js')}" type="text/javascript"></script>
    <style>
        #map { height: 400px; }
    </style>
    <script type="text/javascript">
        $('timerange_ul').timerange();
    </script>
</head>
<body>
    <div id="timerange_json">
    </div>
    <div id="timerange_ul">
        <ul>
            <li data-start="2013-01-01 5:50am" data-end="2013-02-05 2:03am"></li>
            <li data-start="2013-01-02" data-length="50 minutes"></li>
        <ul>
    </div>
   	<div id="datepicker"></div>
   	<div id="map"></div>
   	<div id="timeline"></div>
    <script type="text/javascript">
        var json_points = ${json_points};
        var tracks = ${json_tracks};
        var segments = ${json_segments};
        //var points = ${points};
    </script>
	<script type="text/javascript">
    var seglist = {};
    $(function() {
        /*
        tm = TimeMap.init({
            mapId: "map",               // Id of map div element (required)
            timelineId: "timeline",     // Id of timeline div element (required)
            options: {},
            datasets: [],
        });
        */

		var map = new mxn.Mapstraction('map', 'googlev3'); 
        map.enableScrollWheelZoom();
        map.addControls({
            scale:true,
            map_type:true,
        });
        var points = Array();
        var bb = new mxn.BoundingBox();
        var track;
        for(segid in json_points) {
            last_color = false;
            seglist[segid] = [];
            for(idx in json_points[segid]) {
                curpoint = json_points[segid][idx];
                if(last_color && curpoint[2] != last_color) {
                    newline = new mxn.Polyline(points);
                    newline.setColor(last_color);
                    newline.setWidth('4');
                    seglist[segid].push(newline);
                    map.addPolyline(newline);
                    points = [];
                }
                last_color = curpoint[2];
                points.push(new mxn.LatLonPoint(json_points[segid][idx][0], json_points[segid][idx][1])) 
            }
            if(points.length) {
                newline = new mxn.Polyline(points);
                newline.setColor(last_color);
                newline.setWidth('4');
                seglist[segid].push(newline);
                map.addPolyline(newline);
                points = [];
            }
            newli = $('<li><a href="#" data-segid="' + segid + '">' + tracks[segments[segid].track_id].name + ' (' + segid + ')</a></li>');
            $('#seg_list').append(newli);
            console.log(newli);
        }
		map.polylineCenterAndZoom();

        $('#seg_list').on('mouseover','li a',function() {
            segid = $(this).data('segid');
            $.each(seglist[segid], function(idx, seg) {
                seg.oldcolor = seg.color;
                seg.setColor('#0000FF');
                seg.hide();
            })
        });
        $('#seg_list').on('mouseout','li a',function() {
            segid = $(this).data('segid');
            $.each(seglist[segid], function(idx, seg) {
                seg.setColor(seg.oldcolor);
                seg.show();
            })
        });
    });
	</script> 
    <ul id="seg_list">
    </ul> 
</body>
</html>
